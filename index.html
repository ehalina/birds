<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Запись при движении</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        
        #videoPreview {
            width: 100%;
            max-width: 640px;
            height: auto;
            border-radius: 10px;
            background: #000;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 640px;
        }
        
        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        #startBtn {
            background: #4CAF50;
            color: white;
        }
        
        #startBtn:hover:not(:disabled) {
            background: #45a049;
        }
        
        #stopBtn {
            background: #f44336;
            color: white;
            display: none;
        }
        
        #stopBtn:hover:not(:disabled) {
            background: #da190b;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #2a2a2a;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .info {
            font-size: 14px;
            color: #aaa;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Запись при движении</h1>
        <video id="videoPreview" autoplay playsinline muted></video>
        <div class="controls">
            <button id="startBtn">Начать</button>
            <button id="stopBtn">Остановить запись</button>
            <div class="status" id="status">Готов к работе</div>
            <div class="info" id="info"></div>
        </div>
    </div>

    <script>
        const videoPreview = document.getElementById('videoPreview');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const info = document.getElementById('info');
        
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let canvas = null;
        let ctx = null;
        let lastFrame = null;
        let isRecording = false;
        let motionTimeout = null;
        let lastMotionTime = Date.now();
        const MOTION_THRESHOLD = 30;
        const NO_MOTION_TIMEOUT = 30000; // 30 секунд
        
        // Параметры для обнаружения движения
        const DETECTION_INTERVAL = 100; // проверка каждые 100мс
        const PIXEL_THRESHOLD = 50; // порог изменения пикселя
        
        async function requestPermissions() {
            try {
                // Запрос доступа к камере
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });
                
                videoPreview.srcObject = stream;
                status.textContent = 'Камера подключена';
                
                // Создаем canvas для анализа движения
                canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 240;
                ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                return true;
            } catch (error) {
                status.textContent = 'Ошибка доступа к камере: ' + error.message;
                console.error('Ошибка доступа к камере:', error);
                return false;
            }
        }
        
        function detectMotion() {
            if (!stream || !canvas || !ctx) return false;
            
            try {
                ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
                const currentFrame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                if (!lastFrame) {
                    lastFrame = currentFrame;
                    return false;
                }
                
                let diffCount = 0;
                const data1 = lastFrame.data;
                const data2 = currentFrame.data;
                
                for (let i = 0; i < data1.length; i += 4) {
                    const r1 = data1[i];
                    const g1 = data1[i + 1];
                    const b1 = data1[i + 2];
                    
                    const r2 = data2[i];
                    const g2 = data2[i + 1];
                    const b2 = data2[i + 2];
                    
                    const diff = Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2);
                    if (diff > PIXEL_THRESHOLD) {
                        diffCount++;
                    }
                }
                
                lastFrame = currentFrame;
                
                const motionDetected = diffCount > (canvas.width * canvas.height * 0.01);
                return motionDetected;
            } catch (error) {
                console.error('Ошибка обнаружения движения:', error);
                return false;
            }
        }
        
        let motionDetectionInterval = null;
        
        function startMotionDetection() {
            if (motionDetectionInterval) return;
            
            motionDetectionInterval = setInterval(() => {
                const hasMotion = detectMotion();
                
                if (hasMotion) {
                    lastMotionTime = Date.now();
                    
                    if (!isRecording) {
                        // Начинаем запись при первом обнаружении движения
                        startRecording();
                    } else {
                        // Сбрасываем таймер отсутствия движения
                        if (motionTimeout) {
                            clearTimeout(motionTimeout);
                        }
                        motionTimeout = setTimeout(() => {
                            if (isRecording) {
                                stopRecording();
                                status.textContent = 'Запись остановлена: нет движения 30 сек';
                            }
                        }, NO_MOTION_TIMEOUT);
                    }
                } else if (isRecording) {
                    // Проверяем таймер отсутствия движения
                    const timeSinceMotion = Date.now() - lastMotionTime;
                    if (timeSinceMotion >= NO_MOTION_TIMEOUT && !motionTimeout) {
                        motionTimeout = setTimeout(() => {
                            if (isRecording) {
                                stopRecording();
                                status.textContent = 'Запись остановлена: нет движения 30 сек';
                            }
                        }, NO_MOTION_TIMEOUT - timeSinceMotion);
                    }
                }
            }, DETECTION_INTERVAL);
        }
        
        function stopMotionDetection() {
            if (motionDetectionInterval) {
                clearInterval(motionDetectionInterval);
                motionDetectionInterval = null;
            }
        }
        
        function startRecording() {
            if (isRecording) return;
            
            try {
                recordedChunks = [];
                
                const options = {
                    mimeType: 'video/webm;codecs=vp9,opus',
                    videoBitsPerSecond: 2500000
                };
                
                // Пробуем другие форматы, если webm не поддерживается
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm;codecs=vp8,opus';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/mp4';
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        recordedChunks.push(event.data);
                        console.log('Получен фрагмент:', event.data.size, 'байт. Всего фрагментов:', recordedChunks.length);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    console.log('Запись остановлена. Всего фрагментов:', recordedChunks.length);
                    if (recordedChunks.length > 0) {
                        saveVideo();
                    } else {
                        status.textContent = 'Ошибка: нет записанных данных';
                        info.textContent = 'Попробуйте записать снова';
                    }
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('Ошибка MediaRecorder:', event.error);
                    status.textContent = 'Ошибка записи: ' + event.error.message;
                };
                
                mediaRecorder.start(1000); // собираем данные каждую секунду
                isRecording = true;
                
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                status.textContent = 'Запись...';
                status.classList.add('recording');
                info.textContent = 'Обнаружено движение!';
                
            } catch (error) {
                status.textContent = 'Ошибка начала записи: ' + error.message;
                console.error('Ошибка записи:', error);
                isRecording = false;
            }
        }
        
        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            if (motionTimeout) {
                clearTimeout(motionTimeout);
                motionTimeout = null;
            }
            
            isRecording = false;
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            status.textContent = 'Остановка записи...';
            status.classList.remove('recording');
            info.textContent = '';
            
            stopMotionDetection();
            
            // Останавливаем запись и собираем все данные
            if (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused') {
                // Запрашиваем финальные данные перед остановкой
                try {
                    mediaRecorder.requestData();
                } catch (e) {
                    console.log('Не удалось запросить данные:', e);
                }
                
                setTimeout(() => {
                    if (mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                }, 100);
            }
        }
        
        async function saveVideo() {
            if (recordedChunks.length === 0) {
                status.textContent = 'Ошибка: нет данных для сохранения';
                return;
            }
            
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `motion-recording-${timestamp}.webm`;
            
            try {
                // Пробуем использовать File System Access API (Chrome, Edge)
                if ('showSaveFilePicker' in window) {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'Video files',
                            accept: { 'video/webm': ['.webm'] }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    
                    status.textContent = 'Видео сохранено в галерею';
                    info.textContent = 'Файл успешно сохранен';
                } else {
                    // Fallback для мобильных устройств и других браузеров
                    const url = URL.createObjectURL(blob);
                    
                    // Создаем видимую ссылку для скачивания
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'block';
                    downloadLink.style.padding = '15px';
                    downloadLink.style.marginTop = '10px';
                    downloadLink.style.background = '#4CAF50';
                    downloadLink.style.color = 'white';
                    downloadLink.style.textAlign = 'center';
                    downloadLink.style.borderRadius = '8px';
                    downloadLink.style.textDecoration = 'none';
                    downloadLink.textContent = 'Нажмите для сохранения видео';
                    
                    // Добавляем в DOM
                    const controls = document.querySelector('.controls');
                    const existingLink = controls.querySelector('.download-link');
                    if (existingLink) {
                        existingLink.remove();
                    }
                    downloadLink.classList.add('download-link');
                    controls.appendChild(downloadLink);
                    
                    // Пробуем автоматически скачать
                    downloadLink.click();
                    
                    // Удаляем ссылку через 10 секунд
                    setTimeout(() => {
                        if (downloadLink.parentNode) {
                            downloadLink.remove();
                        }
                        URL.revokeObjectURL(url);
                    }, 10000);
                    
                    status.textContent = 'Видео готово к сохранению';
                    info.textContent = 'Нажмите на зеленую кнопку выше для сохранения';
                }
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                
                // Последний fallback - открыть в новом окне
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                status.textContent = 'Видео готово';
                info.textContent = 'Если файл не скачался, откройте ссылку вручную';
            }
            
            // Очищаем данные
            recordedChunks = [];
        }
        
        startBtn.addEventListener('click', async () => {
            if (!stream) {
                const success = await requestPermissions();
                if (!success) return;
            }
            
            // Ждем немного для стабилизации камеры
            setTimeout(() => {
                status.textContent = 'Ожидание движения...';
                info.textContent = 'Наведите камеру на движущийся объект';
                startMotionDetection();
            }, 1000);
        });
        
        stopBtn.addEventListener('click', () => {
            stopRecording();
        });
        
        // Обработка остановки потока
        videoPreview.addEventListener('loadedmetadata', () => {
            status.textContent = 'Камера готова. Нажмите "Начать"';
        });
    </script>
</body>
</html>
